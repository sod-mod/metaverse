# Bug Fixes - Hero List Display Issues

## Date: 2025-11-08

## Issues Fixed

### 1. ✅ React Key Duplication Warning

**Problem:**
```
Warning: Encountered two children with the same key, `stats`. 
Keys should be unique so that components maintain their identity across updates.
```

**Root Cause:**
All stat columns (STR, INT, CON, AGI, MEN, Total) in the hero list table were using the same key `'stats'`, causing React to throw warnings about duplicate keys.

**Solution:**
Updated `src/pages/HeroList.jsx` to use unique keys for each stat column:
- Changed from: `key: 'stats'` (all columns)
- Changed to: `key: 'stats.str'`, `key: 'stats.int'`, etc. (unique keys)

**Files Modified:**
- `src/pages/HeroList.jsx` - Lines 67-102
- `src/components/SortableTable.jsx` - Added `getNestedValue()` helper function to handle nested keys like `stats.str`

**Code Changes:**
```jsx
// Before
{ key: 'stats', render: (stats) => stats?.str }

// After
{ key: 'stats.str', render: (_, hero) => hero.stats?.str }
```

---

### 2. ✅ Hero Images Not Displaying

**Problem:**
Hero avatar images were not loading in the hero list table.

**Root Cause:**
The hero IDs in the merged `heroes.json` (from CSV) don't match the image file IDs (from game binary extraction). For example:
- Hero #1 (Zhang Jiao) in CSV → Image file is `3_zhang_jiao.webp` (old ID = 3)
- Hero #2 (Diao Chan) in CSV → Image file is `4_diao_chan.webp` (old ID = 4)

**Solution:**
Updated `src/components/HeroAvatar.jsx` to implement a fallback mechanism:
1. Try loading image with new ID from CSV
2. If fails, try with old ID from `rawData[0]` (binary data)
3. If fails, try with just the hero name
4. If all fail, show placeholder with hero ID

**Files Modified:**
- `src/components/HeroAvatar.jsx` - Lines 35-86

**Code Changes:**
```jsx
// Multiple fallback paths
const imagePaths = [
  `/images/heroes/${imageId}_${sanitizedName}.webp`,          // Try new ID
  `/images/heroes/${oldId}_${sanitizedName}.webp`,            // Try old ID
  `/images/heroes/${sanitizedName}.webp`                       // Try name only
].filter(Boolean);

// Progressive fallback on error
if (imageError && triedPaths < imagePaths.length - 1) {
  setImageUrl(imagePaths[triedPaths + 1]);
  setTriedPaths(triedPaths + 1);
  setImageError(false);
}
```

---

## Technical Details

### SortableTable Enhancement

Added support for nested object property access in sorting and filtering:

```javascript
const getNestedValue = (obj, path) => {
  if (!path) return obj
  return path.split('.').reduce((acc, part) => acc?.[part], obj)
}
```

This allows columns to reference nested properties like `stats.str`, `stats.int`, etc.

### Image Path Resolution

The HeroAvatar component now maintains state for progressive fallback:
```javascript
const [imageUrl, setImageUrl] = useState(imagePaths[0]);
const [triedPaths, setTriedPaths] = useState(0);
```

When an image fails to load, it automatically tries the next path in the array.

---

## Testing

### Verified
- ✅ No more React key warnings in console
- ✅ Images load correctly with fallback mechanism
- ✅ Sorting works on all stat columns (STR, INT, CON, AGI, MEN, Total)
- ✅ Filtering works across nested properties
- ✅ Placeholder displays for missing images (shows hero ID)

### Affected Components
- `HeroList.jsx` - Hero list page
- `HeroAvatar.jsx` - Avatar display component
- `SortableTable.jsx` - Reusable sortable table

---

## Future Improvements

1. **Image ID Mapping**: Create a proper ID mapping file to directly match CSV IDs to image file IDs
2. **Image Pre-processing**: Regenerate hero images with correct IDs from the CSV
3. **Lazy Loading**: Implement lazy loading for hero images to improve initial page load
4. **Image Optimization**: Add responsive image sizes (WebP with fallbacks)

---

## Related Issues

- This fix is related to the hero data merge (CSV + Binary) completed earlier
- Hero IDs were renumbered in CSV but images retain old IDs from binary extraction
- The fallback mechanism is a temporary solution until images are regenerated

---

## Files Modified Summary

```
src/pages/HeroList.jsx          - Fixed duplicate keys, updated render functions
src/components/HeroAvatar.jsx   - Added fallback image loading mechanism
src/components/SortableTable.jsx - Added nested property access support
```

---

## Verification Steps

1. Start dev server: `npm run dev`
2. Navigate to Heroes page
3. Check browser console - no more React key warnings ✅
4. Verify hero images display (or show placeholder) ✅
5. Test sorting on stat columns ✅
6. Test filtering ✅

---

**Status**: ✅ Both issues resolved
**Tested**: ✅ All functionality working
**Ready for**: Production deployment

